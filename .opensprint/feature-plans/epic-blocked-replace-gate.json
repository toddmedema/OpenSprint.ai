{
  "title": "Epic-Blocked Model: Replace Plan Approval Gate",
  "content": "# Epic-Blocked Model: Replace Plan Approval Gate\n\n## Overview\n\nRemove the \"Plan Approval Gate\" ticket concept entirely. Instead, epics themselves can be in a blocked state. When an epic is blocked, all tasks within that epic are blocked from appearing in `ready()` and show as \"Planning\" in the UI. When the user clicks \"Execute!\", the epic is unblocked and its tasks become eligible for execution based on their own dependencies.\n\nThis simplifies the model: no separate gate task, no `blocks` dependencies from implementation tasks to a gate. The epic's status directly controls whether its child tasks can be picked by the orchestrator.\n\n## Acceptance Criteria\n\n- No gate tasks are created when creating a new Plan or during Re-execute\n- Epics for Plans start with `status: \"blocked\"`; clicking \"Execute!\" sets epic `status: \"open\"`\n- Tasks in a blocked epic do not appear in `ready()` and show kanban column \"planning\"\n- Plan status (planning/building/complete) is derived from epic status and task completion, not gate task state\n- Re-execute: adding delta tasks sets epic back to `blocked`; second \"Execute!\" unblocks\n- Deploy fix epics: epic created with `status: \"open\"` (no gate, auto-approved)\n- Migration: existing plans with gate tasks are migrated (epic status set from gate state, gate task and its dependencies removed)\n- All existing tests pass; new tests cover epic-blocked behavior\n\n## Technical Approach\n\n1. **Epic status semantics**: `blocked` = plan not approved; `open` = approved; `closed` = complete\n2. **Plan creation**: Create epic with `status: \"blocked\"`, no gate task, no blocks deps on tasks\n3. **shipPlan (Execute!)**: `taskStore.update(projectId, epicId, { status: \"open\" })` instead of closing gate\n4. **Re-execute**: Set epic `blocked` before delta tasks; create tasks without gate; Execute! sets `open`\n5. **ready()**: Exclude tasks whose epic has status \"blocked\"\n6. **computeKanbanColumn**: If epic blocked → \"planning\"; remove gate special cases\n7. **Plan status derivation**: planning = epic blocked; building = epic open + tasks pending; complete = all done\n8. **Deploy fix epic**: Epic with `status: \"open\"`, no gate\n\n## Dependencies\n\n- TaskStoreService supports `status: \"blocked\"` (already supported)\n- No external dependencies\n\n## Data Model Changes\n\n| Entity | Change |\n|--------|--------|\n| PlanMetadata | Remove `gateTaskId`, `reExecuteGateTaskId` |\n| plans table | Make `gate_task_id` nullable |\n| tasks | Epic may have `status: \"blocked\"` |\n| task_dependencies | Remove rows where depends_on_id was gate |\n\n## API Specification\n\nNo new endpoints. `POST /plans/:planId/execute` sets epic open. `GET /tasks/ready` excludes blocked-epic tasks. Plan metadata no longer includes gate IDs.\n\n## UI/UX Requirements\n\n- Execute! button unchanged; logic uses epic blocked state\n- Tasks in blocked epic show \"Planning\" badge\n- No gate task in task list\n- Plan Tasks vs Execute: Execute when epic blocked AND ≥1 task; Plan Tasks when epic blocked AND zero tasks\n\n## Edge Cases and Error Handling\n\n- **Migration**: Gate open → epic blocked; gate closed → epic open; delete gate and deps\n- **Orphaned gates**: Migration removes; no code creates them\n- **Epic without plan**: Fix epics start open\n- **Re-execute no delta**: Don't change epic status\n- **Plan with no epic**: Guard with epicId check\n\n## Testing Strategy\n\n- Unit: TaskService ready/kanban with blocked epic\n- Unit: PlanService create/ship/reship without gate\n- Integration: plan-route, task-route\n- Migration: gate → epic status, gate removed\n\n## Estimated Complexity\n\n**Medium** — Plan service, task service, task store, frontend, deploy-fix-epic, orchestrator, migration, tests.",
  "complexity": "medium",
  "mockups": [
    {
      "title": "Epic Card — Blocked (Planning)",
      "content": "+------------------------------------------------------------------+\n|  EPIC: User Authentication                          [Planning]   |\n+------------------------------------------------------------------+\n|  Plan: auth.md                                                    |\n|                                                                  |\n|  Tasks (blocked — epic not yet approved):                         |\n|  +--------------------------------------------------------------+|\n|  |  os-a3f8.1  Implement login form         Planning            ||\n|  |  os-a3f8.2  Add session middleware       Planning            ||\n|  |  os-a3f8.3  Wire up logout               Planning            ||\n|  +--------------------------------------------------------------+|\n|                                                                  |\n|  [  Execute!  ]  ← Unblocks epic; tasks move to Backlog/Ready     |\n+------------------------------------------------------------------+"
    },
    {
      "title": "Epic Card — Approved (Building)",
      "content": "+------------------------------------------------------------------+\n|  EPIC: User Authentication                          [Building]    |\n+------------------------------------------------------------------+\n|  Tasks (eligible per dependencies):                               |\n|  +--------------------------------------------------------------+|\n|  |  os-a3f8.1  Implement login form         Ready               ||\n|  |  os-a3f8.2  Add session middleware       Backlog (depends)   ||\n|  |  os-a3f8.3  Wire up logout               Backlog             ||\n|  +--------------------------------------------------------------+|\n+------------------------------------------------------------------+"
    }
  ],
  "tasks": [
    {
      "title": "Data model: Remove gate fields from PlanMetadata and plans table",
      "description": "Update PlanMetadata type to remove gateTaskId and reExecuteGateTaskId. Add migration to make plans.gate_task_id nullable. Update PlanInsertData and planInsert to accept null/empty gate_task_id. Ensure backward compat: existing plans with gate_task_id still load.",
      "priority": 0,
      "dependsOn": []
    },
    {
      "title": "TaskService: ready() and kanban exclude tasks in blocked epic",
      "description": "In computeReadyForSingleTask: if task has epicId (from extractEpicId), look up epic in idToIssue; if epic.status === 'blocked', return empty Set (not ready). In computeKanbanColumn: if epic blocked, return 'planning'; remove gate special cases (.0, 'Plan approval gate').",
      "priority": 1,
      "dependsOn": []
    },
    {
      "title": "PlanService.createPlan: Epic blocked, no gate task",
      "description": "Create epic with taskStore.update(projectId, epicId, { status: 'blocked' }) after create. Do NOT create gate task. Do NOT add blocks dependencies from tasks to gate. Pass empty string or null for gate_task_id in planInsert. Update createPlan tests.",
      "priority": 2,
      "dependsOn": ["Data model: Remove gate fields from PlanMetadata and plans table"]
    },
    {
      "title": "PlanService.shipPlan: Unblock epic instead of closing gate",
      "description": "Replace gate-close logic with taskStore.update(projectId, epicId, { status: 'open' }). Remove reExecuteGateTaskId handling. Keep task generation, PRD sync, shippedAt, shipped_content. Update getPlan status derivation to use epic status instead of gate. Update shipPlan tests.",
      "priority": 3,
      "dependsOn": ["PlanService.createPlan: Epic blocked, no gate task"]
    },
    {
      "title": "PlanService.reshipPlan: Epic blocked, no re-execute gate",
      "description": "Before creating delta tasks: taskStore.update(projectId, epicId, { status: 'blocked' }). Create delta tasks without gate; do NOT add blocks dep to gate. Remove reExecuteGateTaskId creation and metadata update. Update reshipPlan tests.",
      "priority": 4,
      "dependsOn": ["PlanService.shipPlan: Unblock epic instead of closing gate"]
    },
    {
      "title": "PlanService: Update countTasks and getPlan status derivation",
      "description": "Remove gateTaskId param from countTasks; filter children by epic prefix and non-epic type only (no isGate). getPlan: derive planning from epic.status === 'blocked' instead of gate state. Remove reExecuteGateTaskId checks.",
      "priority": 5,
      "dependsOn": ["PlanService.shipPlan: Unblock epic instead of closing gate"]
    },
    {
      "title": "PlanService: Remove gate from generateAndCreateTasks, planTasks, syncPlanToBeads",
      "description": "generateAndCreateTasks: do NOT add blocks deps to gate; remove gateTaskId param. planTasks: do NOT create gate; tasks created without gate deps. syncPlanToBeads: remove isGate filter; use epic prefix + non-epic only. Update all plan-service helpers that reference gate.",
      "priority": 6,
      "dependsOn": ["PlanService.createPlan: Epic blocked, no gate task"]
    },
    {
      "title": "Deploy-fix-epic: No gate, epic status open",
      "description": "Create epic with status 'open' (or update immediately after create). Do NOT create gate task. Do NOT add blocks deps from fix tasks. Remove gateTaskId from planInsert. Close gate call removed. Update deploy-fix-epic.service.test.",
      "priority": 7,
      "dependsOn": ["Data model: Remove gate fields from PlanMetadata and plans table"]
    },
    {
      "title": "Frontend: EpicCard and PlanPhase use epic blocked state",
      "description": "Remove planHasGate / gateTaskId / reExecuteGateTaskId from EpicCard and PlanPhase. planHasGate → plan is planning (epic blocked). getNonGateChildTasks → all children (no gate to exclude). plansReadyToExecute: epic blocked AND has tasks. selectedPlanTasks: filter by epicId only.",
      "priority": 8,
      "dependsOn": ["PlanService.shipPlan: Unblock epic instead of closing gate"]
    },
    {
      "title": "Orchestrator and task-scheduler: Remove gate filter",
      "description": "Remove filter for 'Plan approval gate' title in orchestrator readyTasks. Task scheduler already excludes epics; ensure no gate-specific logic. ready() from TaskService already excludes blocked-epic tasks.",
      "priority": 9,
      "dependsOn": ["TaskService: ready() and kanban exclude tasks in blocked epic"]
    },
    {
      "title": "Migration: Migrate existing plans with gate to epic-blocked",
      "description": "For each plan with non-empty gate_task_id: fetch gate task; if gate status open, set epic status blocked; if closed, set epic open. Delete gate task. Delete task_dependencies where depends_on_id = gate_task_id. Update plan metadata to clear gate_task_id. Run on startup or one-time migration script.",
      "priority": 10,
      "dependsOn": [
        "Data model: Remove gate fields from PlanMetadata and plans table",
        "PlanService.shipPlan: Unblock epic instead of closing gate"
      ]
    },
    {
      "title": "Tests: Update all gate-dependent tests",
      "description": "plan-route.test, plan-service.test, task-route.test, task-service.test, executeSlice.test, planSlice.test, PlanPhase.test, deploy-fix-epic.service.test: remove gateTaskId expectations, add epic status assertions. Add new tests for blocked-epic ready/kanban behavior.",
      "priority": 11,
      "dependsOn": [
        "Migration: Migrate existing plans with gate to epic-blocked",
        "Frontend: EpicCard and PlanPhase use epic blocked state"
      ]
    }
  ]
}
